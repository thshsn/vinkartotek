<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vinsmaking</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const SHEET_ID = '1QagDAoCbeuAneC0H37PhIVncqUxIslH8lrchBgyfhnA';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX1qUO2jWSAynR65Ik5c35mp7dyWJMkSSQelRtbmFOyLGsYlS2_8jCoaLNUW9WZVA/exec';
    
    // Helper function to format date from Google Sheets
    const formatDate = (dateValue) => {
      if (!dateValue) return '';
      if (typeof dateValue === 'string' && dateValue.includes('-')) return dateValue;
      if (typeof dateValue === 'string' && dateValue.startsWith('Date(')) {
        const match = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
        if (match) {
          const year = parseInt(match[1]);
          const month = String(parseInt(match[2]) + 1).padStart(2, '0');
          const day = String(parseInt(match[3])).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
      }
      return dateValue;
    };
    
    // Helper function to get wine type emoji
    const getWineTypeEmoji = (wineType) => {
      const emojiMap = {
        'R√∏dvin': 'üç∑',
        'Hvitvin': 'ü•Ç',
        'Ros√©vin': 'üç∑',
        'Orangevin': 'üç∑',
        'Musserende vin': 'ü•Ç',
        'Musserende ros√©vin': 'ü•Ç',
        'Dessertvin': 'üç∑'
      };
      return emojiMap[wineType] || 'üç∑';
    };
    
    function App() {
      const [wines, setWines] = useState([]);
      const [view, setView] = useState('list');
      const [search, setSearch] = useState('');
      const [sortBy, setSortBy] = useState('newest');
      const [filterWineType, setFilterWineType] = useState('');
      const [filterCountry, setFilterCountry] = useState('');
      const [filterRegion, setFilterRegion] = useState('');
      const [filterSubRegion, setFilterSubRegion] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [showDetails, setShowDetails] = useState(false);
      const [selectedWine, setSelectedWine] = useState(null);
      const [editId, setEditId] = useState(null);
      const [saving, setSaving] = useState(false);
      const [form, setForm] = useState({
        name: '', url: '', wineType: '', dateTasted: new Date().toISOString().split('T')[0],
        country: '', region: '', subRegion: '', grapes: '',
        sightClarity: '', sightIntensity: '', sightColor: '',
        noseCondition: '', noseIntensity: '', noseAroma: '',
        sweetness: '', acid: '', tannin: '', body: '', taste: '', length: '', quality: ''
      });

      useEffect(() => { loadData(); }, []);

      const loadData = async () => {
        try {
          const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
          const t = await r.text();
          const j = JSON.parse(t.substring(47).slice(0, -2));
          const ws = j.table.rows.slice(0).map((row, i) => {
            // Parse quality - strip leading single quote if present
            let qualityValue = '';
            if (row.c[20]?.v !== null && row.c[20]?.v !== undefined) {
              qualityValue = String(row.c[20].v);
              // Remove leading single quote if present
              if (qualityValue.startsWith("'")) {
                qualityValue = qualityValue.substring(1);
              }
            } else if (row.c[20]?.f) {
              qualityValue = row.c[20].f;
              if (qualityValue.startsWith("'")) {
                qualityValue = qualityValue.substring(1);
              }
            }
            
            return {
              id: i + 1,
              name: row.c[0]?.v || '', url: row.c[1]?.v || '', wineType: row.c[2]?.v || '',
              dateTasted: formatDate(row.c[3]?.v) || '', country: row.c[4]?.v || '', region: row.c[5]?.v || '',
              subRegion: row.c[6]?.v || '', grapes: row.c[7]?.v || '',
              sightClarity: row.c[8]?.v || '', sightIntensity: row.c[9]?.v || '', noseColor: row.c[10]?.v || '',
              noseCondition: row.c[11]?.v || '', noseIntensity: row.c[12]?.v || '', noseAroma: row.c[13]?.v || '',
              sweetness: row.c[14]?.v || '', acid: row.c[15]?.v || '', tannin: row.c[16]?.v || '',
              body: row.c[17]?.v || '', taste: row.c[18]?.v || '', length: row.c[19]?.v || '', quality: qualityValue
            };
          });
          setWines(ws);
        } catch (e) { alert('Feil: ' + e.message); }
      };

      const save = async () => {
        if (!form.name) { alert('Navn p√•krevd'); return; }
        if (saving) return;
        
        setSaving(true);
        try {
          const body = editId ? {
            action: 'update',
            originalName: wines.find(w => w.id === editId).name,
            originalDate: wines.find(w => w.id === editId).dateTasted,
            ...form
          } : { action: 'add', ...form };
          
          console.log('Sending to server:', body);
          
          const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(body) });
          const res = await r.json();
          
          console.log('Server response:', res);
          
          if (res.success) {
            if (editId) setWines(wines.map(w => w.id === editId ? { ...form, id: editId } : w));
            else setWines([...wines, { ...form, id: Date.now() }]);
            setForm({
              name: '', url: '', wineType: '', dateTasted: new Date().toISOString().split('T')[0],
              country: '', region: '', subRegion: '', grapes: '',
              sightClarity: '', sightIntensity: '', sightColor: '',
              noseCondition: '', noseIntensity: '', noseAroma: '',
              sweetness: '', acid: '', tannin: '', body: '', taste: '', length: '', quality: ''
            });
            setShowForm(false);
            setEditId(null);
          } else alert('Feil: ' + res.message);
        } catch (e) { alert('Feil: ' + e.message); }
        finally { setSaving(false); }
      };

      const del = async (id) => {
        if (!confirm('Slette?')) return;
        try {
          const w = wines.find(w => w.id === id);
          console.log('Deleting wine:', w);
          const r = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'delete', name: w.name, dateTasted: w.dateTasted })
          });
          const res = await r.json();
          console.log('Delete response:', res);
          if (res.success) { setWines(wines.filter(x => x.id !== id)); alert('Slettet!'); }
          else alert('Feil: ' + res.message);
        } catch (e) { alert('Feil: ' + e.message); }
      };

      const filtered = wines.filter(w => {
        const matchesSearch = Object.values(w).some(v => String(v).toLowerCase().includes(search.toLowerCase()));
        const matchesWineType = !filterWineType || w.wineType === filterWineType;
        const matchesCountry = !filterCountry || w.country === filterCountry;
        const matchesRegion = !filterRegion || w.region === filterRegion;
        const matchesSubRegion = !filterSubRegion || w.subRegion === filterSubRegion;
        return matchesSearch && matchesWineType && matchesCountry && matchesRegion && matchesSubRegion;
      });

      const uniqueCountries = [...new Set(wines.map(w => w.country).filter(Boolean))].sort();
      
      // Get regions for selected country
      const uniqueRegions = filterCountry 
        ? [...new Set(wines.filter(w => w.country === filterCountry).map(w => w.region).filter(Boolean))].sort()
        : [];
      
      // Get subregions for selected region
      const uniqueSubRegions = filterRegion 
        ? [...new Set(wines.filter(w => w.country === filterCountry && w.region === filterRegion).map(w => w.subRegion).filter(Boolean))].sort()
        : [];

      const sorted = [...filtered].sort((a, b) => {
        if (sortBy === 'newest') {
          // Sort by actual date field (newest first)
          const dateA = new Date(a.dateTasted || 0);
          const dateB = new Date(b.dateTasted || 0);
          return dateB - dateA;
        }
        if (sortBy === 'quality') {
          const qa = parseFloat(a.quality) || 0;
          const qb = parseFloat(b.quality) || 0;
          return qb - qa;
        }
        if (sortBy === 'country') return (a.country || '').localeCompare(b.country || '');
        if (sortBy === 'wineType') return (a.wineType || '').localeCompare(b.wineType || '');
        return 0;
      });

      return (
        <div className="min-h-screen bg-gradient-to-br from-stone-50 to-gray-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-6">
                <h1 className="text-3xl font-bold">üç∑ Vinsmaking</h1>
                <div className="flex gap-2">
                  <button onClick={() => setShowForm(true)} className="bg-slate-700 text-white px-4 py-2 rounded-lg hover:bg-slate-800">
                    + Legg til
                  </button>
                  <button onClick={() => { loadData(); alert('Oppdatert!'); }} className="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700">
                    ‚Üª Oppdater
                  </button>
                </div>
              </div>
              
              <div className="flex gap-4 mb-6">
                <button onClick={() => setView('list')} className={`px-4 py-2 rounded-lg ${view === 'list' ? 'bg-slate-700 text-white' : 'bg-gray-200'}`}>Utforsk</button>
                <button onClick={() => setView('stats')} className={`px-4 py-2 rounded-lg ${view === 'stats' ? 'bg-slate-700 text-white' : 'bg-gray-200'}`}>Statistikk</button>
              </div>

              {view === 'list' && (
                <div className="space-y-4">
                  <input type="text" placeholder="S√∏k..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full px-4 py-3 border rounded-lg" />
                  <div className="grid grid-cols-2 gap-4">
                    <select value={filterWineType} onChange={(e) => setFilterWineType(e.target.value)} className="px-4 py-3 border rounded-lg">
                      <option value="">Alle typer</option>
                      <option value="R√∏dvin">R√∏dvin</option>
                      <option value="Hvitvin">Hvitvin</option>
                      <option value="Ros√©vin">Ros√©vin</option>
                      <option value="Orangevin">Orangevin</option>
                      <option value="Musserende vin">Musserende vin</option>
                      <option value="Musserende ros√©vin">Musserende ros√©vin</option>
                      <option value="Dessertvin">Dessertvin</option>
                    </select>
                    <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="px-4 py-3 border rounded-lg">
                      <option value="newest">Nyeste f√∏rst</option>
                      <option value="quality">Kvalitet</option>
                      <option value="country">Land</option>
                      <option value="wineType">Type vin</option>
                    </select>
                  </div>
                  <div className="grid grid-cols-3 gap-4">
                    <select 
                      value={filterCountry} 
                      onChange={(e) => {
                        setFilterCountry(e.target.value);
                        setFilterRegion('');
                        setFilterSubRegion('');
                      }} 
                      className="px-4 py-3 border rounded-lg"
                    >
                      <option value="">Alle land</option>
                      {uniqueCountries.map(country => (
                        <option key={country} value={country}>{country}</option>
                      ))}
                    </select>
                    <select 
                      value={filterRegion} 
                      onChange={(e) => {
                        setFilterRegion(e.target.value);
                        setFilterSubRegion('');
                      }}
                      disabled={!filterCountry}
                      className={`px-4 py-3 border rounded-lg ${!filterCountry ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                    >
                      <option value="">Alle regioner</option>
                      {uniqueRegions.map(region => (
                        <option key={region} value={region}>{region}</option>
                      ))}
                    </select>
                    <select 
                      value={filterSubRegion} 
                      onChange={(e) => setFilterSubRegion(e.target.value)}
                      disabled={!filterRegion}
                      className={`px-4 py-3 border rounded-lg ${!filterRegion ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                    >
                      <option value="">Alle underregioner</option>
                      {uniqueSubRegions.map(subRegion => (
                        <option key={subRegion} value={subRegion}>{subRegion}</option>
                      ))}
                    </select>
                  </div>
                </div>
              )}
            </div>

            {view === 'list' && (
              <div className="space-y-4">
                {sorted.length === 0 ? (
                  <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                    {wines.length === 0 ? 'Ingen viner' : 'Ingen match'}
                  </div>
                ) : (
                  sorted.map(w => (
                    <div key={w.id} className="bg-white rounded-lg shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onClick={() => { setSelectedWine(w); setShowDetails(true); }}>
                      <div className="flex justify-between mb-4">
                        <div>
                          <h3 className="text-2xl font-bold">{w.name}</h3>
                          <div className="text-sm">
                            {w.wineType && <span className="mr-4 text-gray-900">{w.wineType}</span>}
                            {w.country && <span className="text-gray-700">{w.country}</span>}
                            {w.region && <span className="ml-2 text-gray-600">{w.region}</span>}
                            {w.subRegion && <span className="ml-2 text-gray-500">{w.subRegion}</span>}
                            {w.dateTasted && <span className="ml-4 text-gray-600">{w.dateTasted}</span>}
                          </div>
                        </div>
                        <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                          {w.url && <a href={w.url} target="_blank" className="px-3 py-1 text-purple-600">üîó</a>}
                          <button onClick={(e) => { e.stopPropagation(); setForm(w); setEditId(w.id); setShowForm(true); }} className="px-3 py-1 bg-blue-500 text-white rounded">Rediger</button>
                          <button onClick={(e) => { e.stopPropagation(); del(w.id); }} className="px-3 py-1 bg-red-500 text-white rounded">Slett</button>
                        </div>
                      </div>
                      {w.quality && (
                        <div className="mb-2">
                          <span className="text-slate-700 font-bold text-xl">
                            {(() => {
                              const rating = parseFloat(w.quality) || 0;
                              let stars = '';
                              for (let i = 1; i <= 5; i++) {
                                if (rating >= i) stars += '‚òÖ';
                                else if (rating >= i - 0.5) stars += '¬Ω';
                                else stars += '‚òÜ';
                              }
                              return stars;
                            })()}
                          </span>
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            )}

            {view === 'stats' && (
              <div className="space-y-6">
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">Sammendrag</h3>
                  <p className="text-3xl font-bold text-slate-700">{wines.length}</p>
                  <p>Totalt viner</p>
                </div>

                {/* Type vin statistics */}
                {(() => {
                  const wineTypeCounts = {};
                  wines.forEach(w => {
                    if (w.wineType) {
                      wineTypeCounts[w.wineType] = (wineTypeCounts[w.wineType] || 0) + 1;
                    }
                  });
                  const wineTypeData = Object.entries(wineTypeCounts).sort((a, b) => b[1] - a[1]);
                  const total = wineTypeData.reduce((sum, [, count]) => sum + count, 0);
                  
                  return wineTypeData.length > 0 && (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <h3 className="text-xl font-bold mb-4">Type vin</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <ul className="space-y-2">
                            {wineTypeData.map(([type, count]) => (
                              <li key={type} className="flex justify-between items-center">
                                <span>{type}</span>
                                <span className="font-semibold">{count} ({Math.round(count/total*100)}%)</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                        <div className="flex items-center justify-center">
                          <svg viewBox="0 0 200 200" className="w-80 h-80">
                            {(() => {
                              let currentAngle = 0;
                              const colors = ['#1e293b', '#334155', '#475569', '#64748b', '#78716c', '#94a3b8', '#a8a29e', '#cbd5e1', '#d6d3d1', '#e2e8f0', '#57534e', '#44403c', '#292524'];
                              const segments = [];
                              wineTypeData.forEach(([type, count], idx) => {
                                const percentage = count / total;
                                const angle = percentage * 360;
                                const endAngle = currentAngle + angle;
                                const x1 = 100 + 80 * Math.cos((currentAngle - 90) * Math.PI / 180);
                                const y1 = 100 + 80 * Math.sin((currentAngle - 90) * Math.PI / 180);
                                const x2 = 100 + 80 * Math.cos((endAngle - 90) * Math.PI / 180);
                                const y2 = 100 + 80 * Math.sin((endAngle - 90) * Math.PI / 180);
                                const largeArc = angle > 180 ? 1 : 0;
                                const path = `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                
                                // Calculate label position
                                const midAngle = (currentAngle + endAngle) / 2;
                                const labelX = 100 + 50 * Math.cos((midAngle - 90) * Math.PI / 180);
                                const labelY = 100 + 50 * Math.sin((midAngle - 90) * Math.PI / 180);
                                
                                segments.push(
                                  <g key={type}>
                                    <path d={path} fill={colors[idx % colors.length]} />
                                    {percentage > 0.05 && <text x={labelX} y={labelY} fontSize="9" fill="white" textAnchor="middle" fontWeight="bold">{type}</text>}
                                  </g>
                                );
                                currentAngle = endAngle;
                              });
                              return segments;
                            })()}
                          </svg>
                        </div>
                      </div>
                    </div>
                  );
                })()}

                {/* Land statistics */}
                {(() => {
                  const countryCounts = {};
                  wines.forEach(w => {
                    if (w.country) {
                      countryCounts[w.country] = (countryCounts[w.country] || 0) + 1;
                    }
                  });
                  const countryData = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]);
                  const total = countryData.reduce((sum, [, count]) => sum + count, 0);
                  
                  return countryData.length > 0 && (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <h3 className="text-xl font-bold mb-4">Land</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <ul className="space-y-2">
                            {countryData.map(([country, count]) => (
                              <li key={country} className="flex justify-between items-center">
                                <span>{country}</span>
                                <span className="font-semibold">{count} ({Math.round(count/total*100)}%)</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                        <div className="flex items-center justify-center">
                          <svg viewBox="0 0 200 200" className="w-80 h-80">
                            {(() => {
                              let currentAngle = 0;
                              const colors = ['#1e293b', '#334155', '#475569', '#64748b', '#78716c', '#94a3b8', '#a8a29e', '#cbd5e1', '#d6d3d1', '#e2e8f0', '#57534e', '#44403c', '#292524', '#0f172a', '#71717a'];
                              const segments = [];
                              countryData.forEach(([country, count], idx) => {
                                const percentage = count / total;
                                const angle = percentage * 360;
                                const endAngle = currentAngle + angle;
                                const x1 = 100 + 80 * Math.cos((currentAngle - 90) * Math.PI / 180);
                                const y1 = 100 + 80 * Math.sin((currentAngle - 90) * Math.PI / 180);
                                const x2 = 100 + 80 * Math.cos((endAngle - 90) * Math.PI / 180);
                                const y2 = 100 + 80 * Math.sin((endAngle - 90) * Math.PI / 180);
                                const largeArc = angle > 180 ? 1 : 0;
                                const path = `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                
                                // Calculate label position
                                const midAngle = (currentAngle + endAngle) / 2;
                                const labelX = 100 + 50 * Math.cos((midAngle - 90) * Math.PI / 180);
                                const labelY = 100 + 50 * Math.sin((midAngle - 90) * Math.PI / 180);
                                
                                segments.push(
                                  <g key={country}>
                                    <path d={path} fill={colors[idx % colors.length]} />
                                    {percentage > 0.05 && <text x={labelX} y={labelY} fontSize="9" fill="white" textAnchor="middle" fontWeight="bold">{country}</text>}
                                  </g>
                                );
                                currentAngle = endAngle;
                              });
                              return segments;
                            })()}
                          </svg>
                        </div>
                      </div>
                    </div>
                  );
                })()}

                {/* Druer statistics */}
                {(() => {
                  const grapeCounts = {};
                  wines.forEach(w => {
                    if (w.grapes) {
                      // Parse grapes field: "Tempranillo 100%", "Cabernet Sauvignon 60%, Merlot 40%", etc.
                      const grapeEntries = w.grapes.split(',').map(g => g.trim());
                      grapeEntries.forEach(entry => {
                        const match = entry.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s*%\s*$/);
                        if (match) {
                          const grapeName = match[1].trim();
                          const percentage = parseFloat(match[2]);
                          grapeCounts[grapeName] = (grapeCounts[grapeName] || 0) + percentage;
                        }
                      });
                    }
                  });
                  const grapeData = Object.entries(grapeCounts).sort((a, b) => b[1] - a[1]);
                  const total = grapeData.reduce((sum, [, count]) => sum + count, 0);
                  
                  return grapeData.length > 0 && (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <h3 className="text-xl font-bold mb-4">Druer</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <ul className="space-y-2 max-h-96 overflow-y-auto">
                            {grapeData.map(([grape, count]) => (
                              <li key={grape} className="flex justify-between items-center">
                                <span>{grape}</span>
                                <span className="font-semibold">{Math.round(count/total*100)}%</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                        <div className="flex items-center justify-center">
                          <svg viewBox="0 0 200 200" className="w-80 h-80">
                            {(() => {
                              let currentAngle = 0;
                              const colors = ['#1e293b', '#334155', '#475569', '#64748b', '#78716c', '#94a3b8', '#a8a29e', '#cbd5e1', '#d6d3d1', '#e2e8f0', '#57534e', '#44403c', '#292524', '#0f172a', '#71717a', '#52525b'];
                              const segments = [];
                              grapeData.slice(0, 10).forEach(([grape, count], idx) => {
                                const percentage = count / total;
                                const angle = percentage * 360;
                                const endAngle = currentAngle + angle;
                                const x1 = 100 + 80 * Math.cos((currentAngle - 90) * Math.PI / 180);
                                const y1 = 100 + 80 * Math.sin((currentAngle - 90) * Math.PI / 180);
                                const x2 = 100 + 80 * Math.cos((endAngle - 90) * Math.PI / 180);
                                const y2 = 100 + 80 * Math.sin((endAngle - 90) * Math.PI / 180);
                                const largeArc = angle > 180 ? 1 : 0;
                                const path = `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                
                                // Calculate label position
                                const midAngle = (currentAngle + endAngle) / 2;
                                const labelX = 100 + 50 * Math.cos((midAngle - 90) * Math.PI / 180);
                                const labelY = 100 + 50 * Math.sin((midAngle - 90) * Math.PI / 180);
                                
                                segments.push(
                                  <g key={grape}>
                                    <path d={path} fill={colors[idx % colors.length]} />
                                    {percentage > 0.08 && <text x={labelX} y={labelY} fontSize="8" fill="white" textAnchor="middle" fontWeight="bold">{grape}</text>}
                                  </g>
                                );
                                currentAngle = endAngle;
                              });
                              return segments;
                            })()}
                          </svg>
                        </div>
                      </div>
                      {grapeData.length > 10 && <p className="text-sm text-gray-500 mt-2">Diagram viser topp 10 druer</p>}
                    </div>
                  );
                })()}

                {/* Quality statistics */}
                {(() => {
                  const qualityCounts = {};
                  wines.forEach(w => {
                    if (w.quality) {
                      const rating = parseFloat(w.quality);
                      if (!isNaN(rating)) {
                        const ratingStr = rating.toString();
                        qualityCounts[ratingStr] = (qualityCounts[ratingStr] || 0) + 1;
                      }
                    }
                  });
                  const qualityData = Object.entries(qualityCounts).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
                  const total = qualityData.reduce((sum, [, count]) => sum + count, 0);
                  
                  return qualityData.length > 0 && (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <h3 className="text-xl font-bold mb-4">Kvalitet</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <ul className="space-y-2">
                            {qualityData.map(([rating, count]) => (
                              <li key={rating} className="flex justify-between items-center">
                                <span>{rating}‚òÖ</span>
                                <span className="font-semibold">{count} ({Math.round(count/total*100)}%)</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                        <div className="flex items-center justify-center">
                          <svg viewBox="0 0 200 200" className="w-80 h-80">
                            {(() => {
                              let currentAngle = 0;
                              const colors = ['#1e293b', '#334155', '#475569', '#64748b', '#78716c', '#94a3b8', '#a8a29e', '#cbd5e1', '#d6d3d1', '#e2e8f0', '#57534e', '#44403c', '#292524', '#0f172a', '#71717a', '#52525b'];
                              const segments = [];
                              qualityData.forEach(([rating, count], idx) => {
                                const percentage = count / total;
                                const angle = percentage * 360;
                                const endAngle = currentAngle + angle;
                                const x1 = 100 + 80 * Math.cos((currentAngle - 90) * Math.PI / 180);
                                const y1 = 100 + 80 * Math.sin((currentAngle - 90) * Math.PI / 180);
                                const x2 = 100 + 80 * Math.cos((endAngle - 90) * Math.PI / 180);
                                const y2 = 100 + 80 * Math.sin((endAngle - 90) * Math.PI / 180);
                                const largeArc = angle > 180 ? 1 : 0;
                                const path = `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                
                                // Calculate label position
                                const midAngle = (currentAngle + endAngle) / 2;
                                const labelX = 100 + 50 * Math.cos((midAngle - 90) * Math.PI / 180);
                                const labelY = 100 + 50 * Math.sin((midAngle - 90) * Math.PI / 180);
                                
                                segments.push(
                                  <g key={rating}>
                                    <path d={path} fill={colors[idx % colors.length]} />
                                    {percentage > 0.05 && <text x={labelX} y={labelY} fontSize="10" fill="white" textAnchor="middle" fontWeight="bold">{rating}‚òÖ</text>}
                                  </g>
                                );
                                currentAngle = endAngle;
                              });
                              return segments;
                            })()}
                          </svg>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}

            {showDetails && selectedWine && (
              <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-auto">
                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-screen overflow-y-auto">
                  <div className="sticky top-0 bg-white p-6 border-b flex justify-between">
                    <h2 className="text-2xl font-bold">{selectedWine.name}</h2>
                    <button onClick={() => { setShowDetails(false); setSelectedWine(null); }} className="text-2xl">√ó</button>
                  </div>
                  <div className="p-6 space-y-4">
                    {selectedWine.url && (
                      <div>
                        <label className="block text-sm font-medium text-gray-600 mb-1">URL</label>
                        <a href={selectedWine.url} target="_blank" className="text-purple-600 hover:underline">{selectedWine.url}</a>
                      </div>
                    )}
                    <div className="grid grid-cols-2 gap-4">
                      {selectedWine.wineType && (
                        <div>
                          <label className="block text-sm font-medium text-gray-600 mb-1">Type vin</label>
                          <p>{selectedWine.wineType}</p>
                        </div>
                      )}
                      {selectedWine.dateTasted && (
                        <div>
                          <label className="block text-sm font-medium text-gray-600 mb-1">Dato smakt</label>
                          <p>{selectedWine.dateTasted}</p>
                        </div>
                      )}
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                      {selectedWine.country && (
                        <div>
                          <label className="block text-sm font-medium text-gray-600 mb-1">Land</label>
                          <p>{selectedWine.country}</p>
                        </div>
                      )}
                      {selectedWine.region && (
                        <div>
                          <label className="block text-sm font-medium text-gray-600 mb-1">Region</label>
                          <p>{selectedWine.region}</p>
                        </div>
                      )}
                      {selectedWine.subRegion && (
                        <div>
                          <label className="block text-sm font-medium text-gray-600 mb-1">Underregion</label>
                          <p>{selectedWine.subRegion}</p>
                        </div>
                      )}
                    </div>
                    {selectedWine.grapes && (
                      <div>
                        <label className="block text-sm font-medium text-gray-600 mb-1">Druer</label>
                        <p>{selectedWine.grapes}</p>
                      </div>
                    )}
                    {(selectedWine.sightClarity || selectedWine.sightIntensity || selectedWine.sightColor) && (
                      <div>
                        <h3 className="font-semibold mb-2">Utseende</h3>
                        <div className="grid grid-cols-3 gap-4">
                          {selectedWine.sightClarity && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Klarhet</label>
                              <p className="text-sm">{selectedWine.sightClarity}</p>
                            </div>
                          )}
                          {selectedWine.sightIntensity && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Intensitet</label>
                              <p className="text-sm">{selectedWine.sightIntensity}</p>
                            </div>
                          )}
                          {selectedWine.sightColor && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Farge</label>
                              <p className="text-sm">{selectedWine.sightColor}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    {(selectedWine.noseCondition || selectedWine.noseIntensity || selectedWine.noseAroma) && (
                      <div>
                        <h3 className="font-semibold mb-2">Duft</h3>
                        <div className="grid grid-cols-3 gap-4">
                          {selectedWine.noseCondition && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Tilstand</label>
                              <p className="text-sm">{selectedWine.noseCondition}</p>
                            </div>
                          )}
                          {selectedWine.noseIntensity && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Intensitet</label>
                              <p className="text-sm">{selectedWine.noseIntensity}</p>
                            </div>
                          )}
                          {selectedWine.noseAroma && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Aroma</label>
                              <p className="text-sm">{selectedWine.noseAroma}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    {(selectedWine.sweetness || selectedWine.acid || selectedWine.tannin || selectedWine.body || selectedWine.taste || selectedWine.length) && (
                      <div>
                        <h3 className="font-semibold mb-2">Smak</h3>
                        <div className="grid grid-cols-4 gap-4 mb-4">
                          {selectedWine.sweetness && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">S√∏dme</label>
                              <p className="text-sm">{selectedWine.sweetness}</p>
                            </div>
                          )}
                          {selectedWine.acid && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Syrlighet</label>
                              <p className="text-sm">{selectedWine.acid}</p>
                            </div>
                          )}
                          {selectedWine.tannin && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Tannin</label>
                              <p className="text-sm">{selectedWine.tannin}</p>
                            </div>
                          )}
                          {selectedWine.body && (
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">Kropp</label>
                              <p className="text-sm">{selectedWine.body}</p>
                            </div>
                          )}
                        </div>
                        {selectedWine.taste && (
                          <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-600 mb-1">Smak</label>
                            <p>{selectedWine.taste}</p>
                          </div>
                        )}
                        {selectedWine.length && (
                          <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">Lengde</label>
                            <p>{selectedWine.length}</p>
                          </div>
                        )}
                      </div>
                    )}
                    {selectedWine.quality && (
                      <div>
                        <label className="block text-sm font-medium text-gray-600 mb-2">Kvalitet</label>
                        <div className="flex gap-1">
                          {[1,2,3,4,5].map(s => {
                            const cr = parseFloat(selectedWine.quality) || 0;
                            return (
                              <span key={s} className="text-4xl text-slate-700">
                                {cr >= s ? '‚òÖ' : cr >= s - 0.5 ? '¬Ω' : '‚òÜ'}
                              </span>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="sticky bottom-0 bg-white flex gap-4 p-6 border-t">
                    <button onClick={() => { setForm(selectedWine); setEditId(selectedWine.id); setShowDetails(false); setShowForm(true); }} className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Rediger</button>
                    <button onClick={() => { setShowDetails(false); setSelectedWine(null); }} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Lukk</button>
                  </div>
                </div>
              </div>
            )}

            {showForm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-auto">
                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-screen overflow-y-auto" id="formModal">
                  <div className="sticky top-0 bg-white p-6 border-b flex justify-between">
                    <h2 className="text-2xl font-bold">{editId ? 'Rediger' : 'Ny vin'}</h2>
                    <button onClick={() => { setShowForm(false); setEditId(null); }} className="text-2xl">√ó</button>
                  </div>
                  <div className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Vinnavn *</label>
                        <input type="text" value={form.name} onChange={(e) => setForm(p => ({ ...p, name: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="w-full px-4 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">URL</label>
                        <input type="url" value={form.url} onChange={(e) => setForm(p => ({ ...p, url: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="w-full px-4 py-2 border rounded-lg" />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Type vin</label>
                        <select value={form.wineType} onChange={(e) => setForm(p => ({ ...p, wineType: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="w-full px-4 py-2 border rounded-lg">
                          <option value="">Velg type</option>
                          <option value="R√∏dvin">R√∏dvin</option>
                          <option value="Hvitvin">Hvitvin</option>
                          <option value="Ros√©vin">Ros√©vin</option>
                          <option value="Orangevin">Orangevin</option>
                          <option value="Musserende vin">Musserende vin</option>
                          <option value="Musserende ros√©vin">Musserende ros√©vin</option>
                          <option value="Dessertvin">Dessertvin</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">Dato</label>
                        <input type="date" value={form.dateTasted} onChange={(e) => setForm(p => ({ ...p, dateTasted: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="w-full px-4 py-2 border rounded-lg" />
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                      <input placeholder="Land" value={form.country} onChange={(e) => setForm(p => ({ ...p, country: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-4 py-2 border rounded-lg" />
                      <input placeholder="Region" value={form.region} onChange={(e) => setForm(p => ({ ...p, region: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-4 py-2 border rounded-lg" />
                      <input placeholder="Underregion" value={form.subRegion} onChange={(e) => setForm(p => ({ ...p, subRegion: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-4 py-2 border rounded-lg" />
                    </div>
                    <input placeholder="Druer" value={form.grapes} onChange={(e) => setForm(p => ({ ...p, grapes: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="w-full px-4 py-2 border rounded-lg" />
                    <div>
                      <h3 className="font-semibold mb-2">Utseende</h3>
                      <div className="grid grid-cols-3 gap-2">
                        <input placeholder="Klarhet" value={form.sightClarity} onChange={(e) => setForm(p => ({ ...p, sightClarity: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Intensitet" value={form.sightIntensity} onChange={(e) => setForm(p => ({ ...p, sightIntensity: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Farge" value={form.sightColor} onChange={(e) => setForm(p => ({ ...p, sightColor: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm" />
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-2">Duft</h3>
                      <div className="grid grid-cols-4 gap-2 mb-2">
                        <input placeholder="Tilstand" value={form.noseCondition} onChange={(e) => setForm(p => ({ ...p, noseCondition: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                        <input placeholder="Intensitet" value={form.noseIntensity} onChange={(e) => setForm(p => ({ ...p, noseIntensity: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                        <textarea placeholder="Aroma" value={form.noseAroma} onChange={(e) => setForm(p => ({ ...p, noseAroma: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} rows={3} className="px-3 py-2 border rounded-lg text-sm resize-none col-span-2" />
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-2">Smak</h3>
                      <div className="grid grid-cols-4 gap-2 mb-2">
                        <input placeholder="S√∏dme" value={form.sweetness} onChange={(e) => setForm(p => ({ ...p, sweetness: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                        <input placeholder="Syrlighet" value={form.acid} onChange={(e) => setForm(p => ({ ...p, acid: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                        <input placeholder="Tannin" value={form.tannin} onChange={(e) => setForm(p => ({ ...p, tannin: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                        <input placeholder="Kropp" value={form.body} onChange={(e) => setForm(p => ({ ...p, body: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm self-start" />
                      </div>
                      <div className="grid grid-cols-4 gap-2">
                        <textarea placeholder="Smak" value={form.taste} onChange={(e) => setForm(p => ({ ...p, taste: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} rows={3} className="px-3 py-2 border rounded-lg text-sm resize-none col-span-3" />
                        <input placeholder="Lengde" value={form.length} onChange={(e) => setForm(p => ({ ...p, length: e.target.value }))} onFocus={(e) => { const modal = document.getElementById('formModal'); if (modal) { const rect = e.target.getBoundingClientRect(); const modalRect = modal.getBoundingClientRect(); modal.scrollTop += rect.top - modalRect.top - 100; } }} className="px-3 py-2 border rounded-lg text-sm align-top self-start" />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">Kvalitet</label>
                      <div className="flex gap-1">
                        {[1,2,3,4,5].map(s => {
                          const cr = parseFloat(form.quality) || 0;
                          return (
                            <span key={s} onClick={() => setForm(p => ({ ...p, quality: (cr === s ? s - 0.5 : s).toString() }))} className="text-4xl cursor-pointer select-none">
                              {cr >= s ? '‚òÖ' : cr === s - 0.5 ? '¬Ω' : '‚òÜ'}
                            </span>
                          );
                        })}
                        {form.quality && <span className="ml-2 text-sm">({form.quality})</span>}
                      </div>
                      <p className="text-xs text-gray-500 mt-1">Klikk for full stjerne. Klikk igjen for halv.</p>
                    </div>
                  </div>
                  <div className="sticky bottom-0 bg-white flex gap-4 p-6 border-t">
                    <button 
                      onClick={save} 
                      disabled={saving}
                      className={`flex-1 py-3 rounded-lg font-semibold ${saving ? 'bg-slate-400 cursor-not-allowed' : 'bg-slate-700 hover:bg-slate-800'} text-white`}
                    >
                      {saving ? 'Lagrer...' : (editId ? 'Oppdater' : 'Legg til')}
                    </button>
                    {editId && (
                      <button 
                        onClick={() => { 
                          setShowForm(false); 
                          setEditId(null); 
                          del(editId); 
                        }} 
                        className="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700"
                      >
                        Slett
                      </button>
                    )}
                    <button onClick={() => { setShowForm(false); setEditId(null); }} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Avbryt</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
