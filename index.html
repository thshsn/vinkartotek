<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vinsmaking</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const SHEET_ID = '1QagDAoCbeuAneC0H37PhIVncqUxIslH8lrchBgyfhnA';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX1qUO2jWSAynR65Ik5c35mp7dyWJMkSSQelRtbmFOyLGsYlS2_8jCoaLNUW9WZVA/exec';
    
    function App() {
      const [wines, setWines] = useState([]);
      const [view, setView] = useState('list');
      const [search, setSearch] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [editId, setEditId] = useState(null);
      const [saving, setSaving] = useState(false);
      const [form, setForm] = useState({
        name: '', url: '', wineType: '', dateTasted: new Date().toISOString().split('T')[0],
        country: '', region: '', subRegion: '', grapes: '',
        sightClarity: '', sightIntensity: '', sightColor: '',
        noseCondition: '', noseIntensity: '', noseAroma: '',
        sweetness: '', acid: '', tannin: '', body: '', taste: '', length: '', quality: ''
      });

      useEffect(() => { loadData(); }, []);

      const loadData = async () => {
        try {
          const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
          const t = await r.text();
          const j = JSON.parse(t.substring(47).slice(0, -2));
          const ws = j.table.rows.slice(0).map((row, i) => ({
            id: i + 1,
            name: row.c[0]?.v || '', url: row.c[1]?.v || '', wineType: row.c[2]?.v || '',
            dateTasted: row.c[3]?.v || '', country: row.c[4]?.v || '', region: row.c[5]?.v || '',
            subRegion: row.c[6]?.v || '', grapes: row.c[7]?.v || '',
            sightClarity: row.c[8]?.v || '', sightIntensity: row.c[9]?.v || '', sightColor: row.c[10]?.v || '',
            noseCondition: row.c[11]?.v || '', noseIntensity: row.c[12]?.v || '', noseAroma: row.c[13]?.v || '',
            sweetness: row.c[14]?.v || '', acid: row.c[15]?.v || '', tannin: row.c[16]?.v || '',
            body: row.c[17]?.v || '', taste: row.c[18]?.v || '', length: row.c[19]?.v || '', quality: row.c[20]?.v || ''
          }));
          setWines(ws);
        } catch (e) { alert('Feil: ' + e.message); }
      };

      const save = async () => {
        if (!form.name) { alert('Navn p√•krevd'); return; }
        if (saving) return;
        
        setSaving(true);
        try {
          const body = editId ? {
            action: 'update',
            originalName: wines.find(w => w.id === editId).name,
            originalDate: wines.find(w => w.id === editId).dateTasted,
            ...form
          } : { action: 'add', ...form };
          
          const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(body) });
          const res = await r.json();
          
          if (res.success) {
            if (editId) setWines(wines.map(w => w.id === editId ? { ...form, id: editId } : w));
            else setWines([...wines, { ...form, id: Date.now() }]);
            setForm({
              name: '', url: '', wineType: '', dateTasted: new Date().toISOString().split('T')[0],
              country: '', region: '', subRegion: '', grapes: '',
              sightClarity: '', sightIntensity: '', sightColor: '',
              noseCondition: '', noseIntensity: '', noseAroma: '',
              sweetness: '', acid: '', tannin: '', body: '', taste: '', length: '', quality: ''
            });
            setShowForm(false);
            setEditId(null);
          } else alert('Feil: ' + res.message);
        } catch (e) { alert('Feil: ' + e.message); }
        finally { setSaving(false); }
      };

      const del = async (id) => {
        if (!confirm('Slette?')) return;
        try {
          const w = wines.find(w => w.id === id);
          const r = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'delete', name: w.name, dateTasted: w.dateTasted })
          });
          const res = await r.json();
          if (res.success) { setWines(wines.filter(x => x.id !== id)); alert('Slettet!'); }
          else alert('Feil: ' + res.message);
        } catch (e) { alert('Feil: ' + e.message); }
      };

      const filtered = wines.filter(w => 
        Object.values(w).some(v => String(v).toLowerCase().includes(search.toLowerCase()))
      );

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-6">
                <h1 className="text-3xl font-bold">üç∑ Vinsmaking</h1>
                <div className="flex gap-2">
                  <button onClick={() => setShowForm(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    + Legg til
                  </button>
                  <button onClick={() => { loadData(); alert('Oppdatert!'); }} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    ‚Üª Oppdater
                  </button>
                </div>
              </div>
              
              <div className="flex gap-4 mb-6">
                <button onClick={() => setView('list')} className={`px-4 py-2 rounded-lg ${view === 'list' ? 'bg-purple-600 text-white' : 'bg-gray-200'}`}>Utforsk</button>
                <button onClick={() => setView('stats')} className={`px-4 py-2 rounded-lg ${view === 'stats' ? 'bg-purple-600 text-white' : 'bg-gray-200'}`}>Statistikk</button>
              </div>

              {view === 'list' && <input type="text" placeholder="S√∏k..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full px-4 py-3 border rounded-lg" />}
            </div>

            {view === 'list' && (
              <div className="space-y-4">
                {filtered.length === 0 ? (
                  <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                    {wines.length === 0 ? 'Ingen viner' : 'Ingen match'}
                  </div>
                ) : (
                  filtered.map(w => (
                    <div key={w.id} className="bg-white rounded-lg shadow-lg p-6">
                      <div className="flex justify-between mb-4">
                        <div>
                          <h3 className="text-2xl font-bold">{w.name}</h3>
                          <div className="text-sm text-gray-600">
                            {w.country && <span>üåç {w.country}</span>} {w.region && <span className="ml-4">üìç {w.region}</span>}
                          </div>
                        </div>
                        <div className="flex gap-2">
                          {w.url && <a href={w.url} target="_blank" className="px-3 py-1 text-purple-600">üîó</a>}
                          <button onClick={() => { setForm(w); setEditId(w.id); setShowForm(true); }} className="px-3 py-1 bg-blue-500 text-white rounded">Rediger</button>
                          <button onClick={() => del(w.id)} className="px-3 py-1 bg-red-500 text-white rounded">Slett</button>
                        </div>
                      </div>
                      {w.quality && <div className="mb-2"><span className="text-purple-600 font-bold">{w.quality} ‚≠ê</span></div>}
                      {(w.sweetness || w.acid || w.tannin) && (
                        <div className="flex gap-2 text-xs">
                          {w.sweetness && <span className="bg-purple-100 px-2 py-1 rounded">S√∏dme: {w.sweetness}</span>}
                          {w.acid && <span className="bg-green-100 px-2 py-1 rounded">Syrlighet: {w.acid}</span>}
                          {w.tannin && <span className="bg-red-100 px-2 py-1 rounded">Tannin: {w.tannin}</span>}
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            )}

            {view === 'stats' && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold mb-4">Sammendrag</h3>
                <p className="text-3xl font-bold text-purple-600">{wines.length}</p>
                <p>Totalt viner</p>
              </div>
            )}

            {showForm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-auto">
                <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-screen overflow-y-auto">
                  <div className="sticky top-0 bg-white p-6 border-b flex justify-between">
                    <h2 className="text-2xl font-bold">{editId ? 'Rediger' : 'Ny vin'}</h2>
                    <button onClick={() => { setShowForm(false); setEditId(null); }} className="text-2xl">√ó</button>
                  </div>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">Vinnavn *</label>
                      <input type="text" value={form.name} onChange={(e) => setForm(p => ({ ...p, name: e.target.value }))} className="w-full px-4 py-2 border rounded-lg" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Type vin</label>
                        <select value={form.wineType} onChange={(e) => setForm(p => ({ ...p, wineType: e.target.value }))} className="w-full px-4 py-2 border rounded-lg">
                          <option value="">Velg type</option>
                          <option value="R√∏dvin">R√∏dvin</option>
                          <option value="Hvitvin">Hvitvin</option>
                          <option value="Ros√©vin">Ros√©vin</option>
                          <option value="Orangevin">Orangevin</option>
                          <option value="Musserende vin">Musserende vin</option>
                          <option value="Musserende ros√©vin">Musserende ros√©vin</option>
                          <option value="Dessertvin">Dessertvin</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">Dato</label>
                        <input type="date" value={form.dateTasted} onChange={(e) => setForm(p => ({ ...p, dateTasted: e.target.value }))} className="w-full px-4 py-2 border rounded-lg" />
                      </div>
                    </div>
                    <input type="url" placeholder="URL" value={form.url} onChange={(e) => setForm(p => ({ ...p, url: e.target.value }))} className="w-full px-4 py-2 border rounded-lg" />
                    <div className="grid grid-cols-3 gap-4">
                      <input placeholder="Land" value={form.country} onChange={(e) => setForm(p => ({ ...p, country: e.target.value }))} className="px-4 py-2 border rounded-lg" />
                      <input placeholder="Region" value={form.region} onChange={(e) => setForm(p => ({ ...p, region: e.target.value }))} className="px-4 py-2 border rounded-lg" />
                      <input placeholder="Underregion" value={form.subRegion} onChange={(e) => setForm(p => ({ ...p, subRegion: e.target.value }))} className="px-4 py-2 border rounded-lg" />
                    </div>
                    <input placeholder="Druer" value={form.grapes} onChange={(e) => setForm(p => ({ ...p, grapes: e.target.value }))} className="w-full px-4 py-2 border rounded-lg" />
                    <div>
                      <h3 className="font-semibold mb-2">Utseende</h3>
                      <div className="grid grid-cols-3 gap-2">
                        <input placeholder="Klarhet" value={form.sightClarity} onChange={(e) => setForm(p => ({ ...p, sightClarity: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Intensitet" value={form.sightIntensity} onChange={(e) => setForm(p => ({ ...p, sightIntensity: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Farge" value={form.sightColor} onChange={(e) => setForm(p => ({ ...p, sightColor: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-2">Duft</h3>
                      <div className="grid grid-cols-3 gap-2">
                        <input placeholder="Tilstand" value={form.noseCondition} onChange={(e) => setForm(p => ({ ...p, noseCondition: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Intensitet" value={form.noseIntensity} onChange={(e) => setForm(p => ({ ...p, noseIntensity: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <textarea placeholder="Aroma" value={form.noseAroma} onChange={(e) => setForm(p => ({ ...p, noseAroma: e.target.value }))} rows={2} className="px-3 py-2 border rounded-lg text-sm resize-none" />
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-2">Smak</h3>
                      <div className="grid grid-cols-4 gap-2 mb-2">
                        <input placeholder="S√∏dme" value={form.sweetness} onChange={(e) => setForm(p => ({ ...p, sweetness: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Syrlighet" value={form.acid} onChange={(e) => setForm(p => ({ ...p, acid: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Tannin" value={form.tannin} onChange={(e) => setForm(p => ({ ...p, tannin: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                        <input placeholder="Kropp" value={form.body} onChange={(e) => setForm(p => ({ ...p, body: e.target.value }))} className="px-3 py-2 border rounded-lg text-sm" />
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <textarea placeholder="Smak" value={form.taste} onChange={(e) => setForm(p => ({ ...p, taste: e.target.value }))} rows={3} className="px-4 py-2 border rounded-lg" />
                        <input placeholder="Lengde" value={form.length} onChange={(e) => setForm(p => ({ ...p, length: e.target.value }))} className="px-4 py-2 border rounded-lg" />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">Kvalitet</label>
                      <div className="flex gap-1">
                        {[1,2,3,4,5].map(s => {
                          const cr = parseFloat(form.quality) || 0;
                          return (
                            <span key={s} onClick={() => setForm(p => ({ ...p, quality: (cr === s ? s - 0.5 : s).toString() }))} className="text-4xl cursor-pointer select-none">
                              {cr >= s ? '‚òÖ' : cr === s - 0.5 ? '¬Ω' : '‚òÜ'}
                            </span>
                          );
                        })}
                        {form.quality && <span className="ml-2 text-sm">({form.quality})</span>}
                      </div>
                      <p className="text-xs text-gray-500 mt-1">Klikk for full stjerne. Klikk igjen for halv.</p>
                    </div>
                  </div>
                  <div className="sticky bottom-0 bg-white flex gap-4 p-6 border-t">
                    <button 
                      onClick={save} 
                      disabled={saving}
                      className={`flex-1 py-3 rounded-lg font-semibold ${saving ? 'bg-purple-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'} text-white`}
                    >
                      {saving ? 'Lagrer...' : (editId ? 'Oppdater' : 'Legg til')}
                    </button>
                    <button onClick={() => { setShowForm(false); setEditId(null); }} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Avbryt</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
